<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∞–π—Å–∞ + –†–∞—Å—Å—Ä–æ—á–∫–∞</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel-2:#0f1117;
      --text:#f5f7ff;
      --muted:#b5bbd6;
      --accent:#7c9bff;
      --danger:#ff6b6b;
      --ok:#7dff9b;
      --border:rgba(255,255,255,0.08);
      --shadow: 0 8px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,155,255,0.18), transparent 60%),
        radial-gradient(1200px 600px at 90% 10%, rgba(102,255,209,0.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      padding: 28px 20px 10px;
      max-width: 1100px;
      margin: 0 auto;
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
    }
    h1{font-size: clamp(20px, 2.8vw, 30px); margin: 0 0 6px;}
    header p{margin:0; color:var(--muted); line-height:1.45; font-size: 13px; max-width: 820px;}
    main{
      max-width:1100px;
      margin: 0 auto;
      padding: 10px 20px 50px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 980px){
      main{ grid-template-columns: 1fr 1fr; align-items:start; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 30%), var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
    }
    .card h2{font-size: 18px; margin: 0 0 10px;}
    .muted{color:var(--muted)}
    .small{font-size: 12.5px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{height:10px}
    textarea{
      width:100%;
      min-height: 360px;
      resize: vertical;
      padding: 12px 12px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.6px;
    }
    input[type="text"], input[type="tel"]{
      width: 220px;
      padding: 10px 12px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
    }
    input.wide{width: 100%}
    button{
      appearance:none;
      border:1px solid transparent;
      background: linear-gradient(90deg, var(--accent), #9b7cff);
      color:white;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 650;
      cursor:pointer;
      transition: transform .05s ease, filter .2s ease, opacity .2s ease;
    }
    button:hover{filter: brightness(1.05)}
    button:active{transform: translateY(1px)}
    button.secondary{background: transparent; border-color: var(--border); color: var(--text);}
    button.ghost{background: transparent; border-color: transparent; color: var(--muted);}
    button:disabled{ opacity: .55; cursor:not-allowed; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11.5px;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--border);
      color: var(--muted);
      white-space: nowrap;
    }
    .pill.ok{color: #d9ffe5; background: rgba(125,255,155,0.08); border-color: rgba(125,255,155,0.25)}
    .pill.bad{color: #ffe1e1; background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.25)}
    .hint{
      padding: 10px 12px;
      background: rgba(124,155,255,0.08);
      border:1px solid rgba(124,155,255,0.28);
      border-radius: 12px;
      color: #e8ecff;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat{
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .stat .label{font-size: 11.5px; color: var(--muted)}
    .stat .value{font-size: 18px; font-weight: 750; margin-top: 2px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .markup-bar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; align-items:center;}
    .markup-btn{
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 720;
      font-size: 12px;
      line-height:1;
    }
    .markup-btn.active{
      background: rgba(124,155,255,0.18);
      border-color: rgba(124,155,255,0.45);
    }

    /* tabs */
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .tab-btn{background: transparent;border:1px solid var(--border);color: var(--text);padding: 10px 12px;border-radius: 999px;font-weight: 720;cursor:pointer}
    .tab-btn.active{background: rgba(124,155,255,0.18); border-color: rgba(124,155,255,0.45);}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* installment quick grid */
    .grid2{display:grid; grid-template-columns: 1fr; gap:10px}
    @media (min-width: 980px){ .grid2{grid-template-columns: 1fr 1fr;} }
    .mini{
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .mini .k{font-size: 11.5px;color: var(--muted)}
    .mini .v{font-size: 16px;font-weight: 750;margin-top:2px}
    .paygrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:8px;
      margin-top:10px;
    }
    .paychip{
      background: rgba(255,255,255,0.04);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      min-height: 58px;
    }
    .paychip .m{font-size: 11.5px;color: var(--muted)}
    .paychip .p{font-size: 14px;font-weight: 800;margin-top:2px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–∞–π—Å–∞</h1>
      <p>
        –í–∫–ª–∞–¥–∫–∞ ¬´–ü—Ä–∞–π—Å¬ª: –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫–µ –∫–∞–∫ –∑–∞–∫—É–ø. –î–ª—è –∑–∞–∫—É–ø–∞ ‚â• 40 000 ‚Äî –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–∫–Ω–æ–ø–∫–∏ –Ω–∞—Ü–µ–Ω–∫–∏),
        –¥–ª—è –∑–∞–∫—É–ø–∞ &lt; 40 000 ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–±–∞–≤–∫–∞ –ø–æ —Å—Ç—É–ø–µ–Ω—è–º. –í–∫–ª–∞–¥–∫–∞ ¬´–†–∞—Å—Å—Ä–æ—á–∫–∞¬ª: –Ω–∞ –≤—Ö–æ–¥ —Ü–µ–Ω–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ ‚Üí /0.70 (+30%) –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ, –ø–ª—é—Å –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂.
      </p>

      <div class="tabbar" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
        <button class="tab-btn active" id="tabPriceBtn" type="button">–ü—Ä–∞–π—Å</button>
        <button class="tab-btn" id="tabInstallmentBtn" type="button">–†–∞—Å—Å—Ä–æ—á–∫–∞</button>
      </div>
    </div>
  </header>

  <div id="priceTab" class="tab-panel active">
    <main>
      <section class="card">
        <h2>–ü—Ä–∞–π—Å ‚Äî –≤—Ö–æ–¥</h2>
        <p class="muted small">–ò—â–µ–º <b>–ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</b> –≤ —Å—Ç—Ä–æ–∫–µ –∏ –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é —Ü–µ–Ω—É.</p>

        <div class="hint small">
          –ù–∞—Ü–µ–Ω–∫–∞ (–¥–ª—è –∑–∞–∫—É–ø–∞ <b>‚â• 40 000</b>):
          <div class="markup-bar" role="group" aria-label="–í—ã–±–æ—Ä –Ω–∞—Ü–µ–Ω–∫–∏">
            <button class="markup-btn" data-factor="0.94" type="button">+6%</button>
            <button class="markup-btn" data-factor="0.93" type="button">+7%</button>
            <button class="markup-btn" data-factor="0.92" type="button">+8%</button>
            <button class="markup-btn" data-factor="0.90" type="button">+10%</button>
            <button class="markup-btn active" data-factor="0.88" type="button">+12%</button>
            <button class="markup-btn" data-factor="0.85" type="button">+15%</button>
            <button class="markup-btn" data-factor="0.80" type="button">+20%</button>
            <button class="markup-btn" data-factor="0.70" type="button">+30%</button>
            <span class="pill ok" id="markupPill">–í—ã–±—Ä–∞–Ω–æ: +12% (/0.88)</span>
          </div>
        </div>

        <div class="spacer"></div>
        <textarea id="inputArea" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫..."></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="convertBtn" type="button">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
          <button id="clearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="exampleBtn" class="ghost" type="button">–ü—Ä–∏–º–µ—Ä</button>
          <span class="pill" title="Ctrl/‚åò + Enter">–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Ctrl/‚åò+Enter</span>
        </div>

        <div class="stats">
          <div class="stat"><div class="label">–°—Ç—Ä–æ–∫ –≤—Å–µ–≥–æ</div><div id="statLines" class="value">0</div></div>
          <div class="stat"><div class="label">–¶–µ–Ω –Ω–∞–π–¥–µ–Ω–æ</div><div id="statFound" class="value">0</div></div>
          <div class="stat"><div class="label">–ë–µ–∑ —Ü–µ–Ω—ã</div><div id="statNoPrice" class="value">0</div></div>
        </div>

        <div class="spacer"></div>
        <div class="hint small">
          –î–ª—è –∑–∞–∫—É–ø–∞ <b>&lt; 40 000</b> –ø—Ä–∏–±–∞–≤–ª—è–µ–º –∏ –∑–∞—Ç–µ–º –æ–∫—Ä—É–≥–ª—è–µ–º:
          &lt;4 000 ‚Üí +1 500; &lt;10 000 ‚Üí +2 000; &lt;15 000 ‚Üí +2 500; &lt;20 000 ‚Üí +3 000; &lt;40 000 ‚Üí +4 000.
          <div class="spacer"></div>
          –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ –æ—Å—Ç–∞—Ç–∫—É –≤–Ω—É—Ç—Ä–∏ —Ç—ã—Å—è—á–∏:
          ‚â§250 ‚Üí 990 –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç—ã—Å—è—á–∏; &gt;250 –∏ &lt;750 ‚Üí 490 —Ç–µ–∫—É—â–µ–π; ‚â•750 ‚Üí 990 —Ç–µ–∫—É—â–µ–π.
        </div>
      </section>

      <section class="card">
        <h2>–ü—Ä–∞–π—Å ‚Äî –≤—ã—Ö–æ–¥</h2>
        <p class="muted small">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç—ã—Å—è—á —Ç–æ—á–∫–æ–π + —Å–∏–º–≤–æ–ª ‚ÇΩ. –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
        <textarea id="outputArea" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç..." readonly></textarea>
        <div class="spacer"></div>
        <div class="row">
          <button id="copyBtn" class="secondary" type="button" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <span id="statusPill" class="pill bad">–û–∂–∏–¥–∞—é –≤–≤–æ–¥</span>
        </div>
      </section>
    </main>
  </div>

  <div id="installmentTab" class="tab-panel">
    <main>
      <section class="card">
        <h2>–†–∞—Å—Å—Ä–æ—á–∫–∞ ‚Äî –±—ã—Å—Ç—Ä—ã–π —Ä–∞—Å—á—ë—Ç</h2>
        <p class="muted small">
          –ù–∞ –≤—Ö–æ–¥ ‚Äî <b>—Ü–µ–Ω–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ</b>. –†–∞—Å—Å—Ä–æ—á–∫–∞ = <span class="mono">–æ—Å—Ç–∞—Ç–æ–∫ / 0.70</span> (+30%) –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–º –∂–µ –ø—Ä–∞–≤–∏–ª–∞–º.
          –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å —É–º–µ–Ω—å—à–∞–µ—Ç ¬´–æ—Å—Ç–∞—Ç–æ–∫¬ª.
        </p>

        <div class="hint small">
          <div class="grid2">
            <div class="row" style="align-items:flex-start; gap:10px">
              <div style="flex:1; min-width:240px">
                <div class="muted small" style="margin-bottom:6px">–¶–µ–Ω–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ, ‚ÇΩ</div>
                <input id="quickCash" class="wide" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 100 000" inputmode="numeric" />
              </div>
              <div style="flex:1; min-width:240px">
                <div class="muted small" style="margin-bottom:6px">–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å, ‚ÇΩ</div>
                <input id="quickDownpay" class="wide" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 50 000" inputmode="numeric" />
              </div>
            </div>

            <div class="row" style="justify-content:space-between; align-items:flex-end">
              <div>
                <div class="muted small">–°—Ä–æ–∫:</div>
                <div class="markup-bar" style="margin-top:6px" role="group" aria-label="–°—Ä–æ–∫ —Ä–∞—Å—Å—Ä–æ—á–∫–∏">
                  <button class="markup-btn active" data-months="6" type="button">6 –º–µ—Å</button>
                  <button class="markup-btn" data-months="12" type="button">12 –º–µ—Å</button>
                  <button class="markup-btn" data-months="24" type="button">24 –º–µ—Å</button>
                  <button class="markup-btn" data-months="36" type="button">36 –º–µ—Å</button>
                </div>
              </div>
              <span class="pill ok" id="monthsPill2">–í—ã–±—Ä–∞–Ω–æ: 6 –º–µ—Å</span>
              <span class="pill" id="instRulePill2">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: /0.70</span>
            </div>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="grid2">
          <div class="mini"><div class="k">–û—Å—Ç–∞—Ç–æ–∫ (—Ü–µ–Ω–∞ ‚àí –≤–∑–Ω–æ—Å)</div><div class="v" id="qRemaining">‚Äî</div></div>
          <div class="mini"><div class="k">–°—É–º–º–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ (–æ–∫—Ä—É–≥–ª—ë–Ω–Ω–∞—è)</div><div class="v" id="qSum">‚Äî</div></div>
          <div class="mini"><div class="k">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (–≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ä–æ–∫)</div><div class="v" id="qMonthly">‚Äî</div></div>
          <div class="mini"><div class="k">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ (–≤–∑–Ω–æ—Å + —Ä–∞—Å—Å—Ä–æ—á–∫–∞)</div><div class="v" id="qTotal">‚Äî</div></div>
        </div>

        <div class="paygrid" aria-label="–ü–ª–∞—Ç–µ–∂–∏ –ø–æ —Å—Ä–æ–∫–∞–º">
          <div class="paychip"><div class="m">6 –º–µ—Å</div><div class="p" id="pay6">‚Äî</div></div>
          <div class="paychip"><div class="m">12 –º–µ—Å</div><div class="p" id="pay12">‚Äî</div></div>
          <div class="paychip"><div class="m">24 –º–µ—Å</div><div class="p" id="pay24">‚Äî</div></div>
          <div class="paychip"><div class="m">36 –º–µ—Å</div><div class="p" id="pay36">‚Äî</div></div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <button id="qCopyBtn" class="secondary" type="button" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
          <span class="pill" id="qStatus">–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É</span>
        </div>

        <div class="spacer"></div>

        <div class="hint small">
          –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ –æ—Å—Ç–∞—Ç–∫—É –≤–Ω—É—Ç—Ä–∏ —Ç—ã—Å—è—á–∏: ‚â§250 ‚Üí 990 –ø—Ä–µ–¥—ã–¥—É—â–µ–π; &gt;250 –∏ &lt;750 ‚Üí 490 —Ç–µ–∫—É—â–µ–π; ‚â•750 ‚Üí 990 —Ç–µ–∫—É—â–µ–π.
        </div>
      </section>

      <section class="card">
        <h2>–†–∞—Å—Å—Ä–æ—á–∫–∞ ‚Äî —Å–ø–∏—Å–æ–∫</h2>
        <p class="muted small">
          –í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫: –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –≤ —Å—Ç—Ä–æ–∫–µ –∫–∞–∫ —Ü–µ–Ω—É –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —Å—É–º–º—É —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂.
        </p>

        <div class="hint small">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="muted small">–í–∑–Ω–æ—Å –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, ‚ÇΩ:</span>
              <input id="downpayInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 50 000" inputmode="numeric" />
            </div>
            <span class="pill" id="monthsPill">–°—Ä–æ–∫: 6 –º–µ—Å</span>
          </div>
        </div>

        <div class="spacer"></div>

        <textarea id="instInputArea" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ..."></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="instCalcBtn" type="button">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
          <button id="instClearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="instExampleBtn" class="ghost" type="button">–ü—Ä–∏–º–µ—Ä</button>
          <span class="pill" title="Ctrl/‚åò + Enter">–ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: Ctrl/‚åò+Enter</span>
        </div>

        <div class="spacer"></div>
        <textarea id="instOutputArea" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç..." readonly></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="instCopyBtn" class="secondary" type="button" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <span id="instStatusPill" class="pill bad">–û–∂–∏–¥–∞—é –≤–≤–æ–¥</span>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function formatRub(n){
    const s = String(Math.trunc(n));
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function parseMoneyInput(s){
    const digits = String(s || "").replace(/\D/g, "");
    return digits ? parseInt(digits, 10) : 0;
  }
  function prettyInput(value){
    const n = parseMoneyInput(value);
    if(!n) return value && value.trim() ? "0" : "";
    return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function roundRule(value){
    if(!isFinite(value) || value <= 0) return 0;
    const baseTh = Math.floor(value / 1000) * 1000;
    const rem = value - baseTh;
    const eps = 1e-9;
    if(baseTh === 0 && rem <= 250 + eps) return 990;
    if(rem <= 250 + eps) return (baseTh - 1000) + 990;
    if(rem < 750 - eps) return baseTh + 490;
    return baseTh + 990;
  }
  function findLastNumberToken(line){
    const re = /\d[\d\s.,]*\d|\d/g;
    let m, last = null;
    while((m = re.exec(line)) !== null){
      last = { text: m[0], index: m.index };
    }
    return last;
  }
  function parsePriceFromToken(tokenText){
    const digits = tokenText.replace(/\D/g, "");
    if(!digits) return null;
    return parseInt(digits, 10);
  }
  function replaceToken(line, token, replacement){
    const before = line.slice(0, token.index);
    const after = line.slice(token.index + token.text.length);
    return before + replacement + after;
  }
  function setPill(el, ok, text){
    el.className = "pill " + (ok ? "ok" : "bad");
    el.textContent = text;
  }
  function debounce(fn, delay){
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }
  function hotkey(handler){
    return (e) => {
      const isMac = (navigator.platform || "").toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if(mod && e.key === "Enter"){
        e.preventDefault();
        handler();
      }
    };
  }

  /* tabs */
  const tabPriceBtn = $("tabPriceBtn");
  const tabInstallmentBtn = $("tabInstallmentBtn");
  const priceTab = $("priceTab");
  const installmentTab = $("installmentTab");
  function setTab(which){
    const isPrice = which === "price";
    tabPriceBtn.classList.toggle("active", isPrice);
    tabInstallmentBtn.classList.toggle("active", !isPrice);
    priceTab.classList.toggle("active", isPrice);
    installmentTab.classList.toggle("active", !isPrice);
  }
  tabPriceBtn.addEventListener("click", () => setTab("price"));
  tabInstallmentBtn.addEventListener("click", () => setTab("installment"));

  /* PRICE */
  const inputArea = $("inputArea");
  const outputArea = $("outputArea");
  const convertBtn = $("convertBtn");
  const clearBtn = $("clearBtn");
  const exampleBtn = $("exampleBtn");
  const copyBtn = $("copyBtn");
  const statusPill = $("statusPill");
  const statLines = $("statLines");
  const statFound = $("statFound");
  const statNoPrice = $("statNoPrice");
  const markupBtns = Array.from(document.querySelectorAll('#priceTab .markup-btn[data-factor]'));
  const markupPill = $("markupPill");
  let selectedFactor = 0.88;

  function cashAdd(p){
    if(p < 4000) return 1500;
    if(p < 10000) return 2000;
    if(p < 15000) return 2500;
    if(p < 20000) return 3000;
    if(p < 40000) return 4000;
    return 0;
  }

  function convertLinePrice(line){
    const token = findLastNumberToken(line);
    if(!token) return { line, ok:false };
    const price = parsePriceFromToken(token.text);
    if(price == null) return { line, ok:false };

    let baseValue;
    if(price < 40000) baseValue = price + cashAdd(price);
    else baseValue = price / selectedFactor;

    const rounded = roundRule(baseValue);
    const formatted = formatRub(rounded) + "‚ÇΩ";
    return { line: replaceToken(line, token, formatted), ok:true };
  }

  function updateStats(linesCount, foundCount){
    statLines.textContent = String(linesCount);
    statFound.textContent = String(foundCount);
    statNoPrice.textContent = String(Math.max(0, linesCount - foundCount));
  }

  function doConvertPrice(){
    const lines = (inputArea.value ?? "").split(/\r?\n/);
    let found = 0;
    const out = lines.map(l => {
      if(l.trim() === "") return "";
      const res = convertLinePrice(l);
      if(res.ok) found++;
      return res.line;
    }).join("\n");
    outputArea.value = out;

    const nonEmpty = lines.filter(l => l.trim() !== "").length;
    updateStats(nonEmpty, found);

    if(found > 0){
      setPill(statusPill, true, "–ì–æ—Ç–æ–≤–æ");
      copyBtn.disabled = false;
    } else {
      setPill(statusPill, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω");
      copyBtn.disabled = true;
    }
  }

  function setActiveMarkupButton(btn){
    markupBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedFactor = parseFloat(btn.dataset.factor);
    markupPill.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${btn.textContent.trim()} (/${selectedFactor.toFixed(2)})`;
    if((inputArea.value || "").trim() && (outputArea.value || "").trim()) doConvertPrice();
  }

  markupBtns.forEach(btn => btn.addEventListener("click", () => setActiveMarkupButton(btn)));
  convertBtn.addEventListener("click", doConvertPrice);
  inputArea.addEventListener("keydown", hotkey(doConvertPrice));

  clearBtn.addEventListener("click", () => {
    inputArea.value = "";
    outputArea.value = "";
    updateStats(0,0);
    copyBtn.disabled = true;
    setPill(statusPill, false, "–û–∂–∏–¥–∞—é –≤–≤–æ–¥");
  });

  exampleBtn.addEventListener("click", () => {
    inputArea.value =
`AirPods 4 ANC 34900üáØüáµ
Apple Watch SE 40 39.500üá¶üá™

16E 256 Black 54400üáÆüá≥
17 Air 256 Blue eSim 70800üá∫üá∏

Z Flip 7 5G 12/256 67.000üá¶üá™`;
  });

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(outputArea.value);
      setPill(statusPill, true, "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
      setTimeout(() => setPill(statusPill, true, "–ì–æ—Ç–æ–≤–æ"), 700);
    }catch(e){
      setPill(statusPill, false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  });

  /* INSTALLMENT */
  const quickCash = $("quickCash");
  const quickDownpay = $("quickDownpay");
  const qRemaining = $("qRemaining");
  const qSum = $("qSum");
  const qMonthly = $("qMonthly");
  const qTotal = $("qTotal");
  const pay6 = $("pay6");
  const pay12 = $("pay12");
  const pay24 = $("pay24");
  const pay36 = $("pay36");
  const monthsPill2 = $("monthsPill2");
  const qCopyBtn = $("qCopyBtn");
  const qStatus = $("qStatus");

  const downpayInput = $("downpayInput");
  const instInputArea = $("instInputArea");
  const instOutputArea = $("instOutputArea");
  const instCalcBtn = $("instCalcBtn");
  const instClearBtn = $("instClearBtn");
  const instExampleBtn = $("instExampleBtn");
  const instCopyBtn = $("instCopyBtn");
  const instStatusPill = $("instStatusPill");
  const monthsPill = $("monthsPill");
  const monthsBtns = Array.from(document.querySelectorAll('#installmentTab .markup-btn[data-months]'));
  let selectedMonths = 6;

  function installmentCalc(cash, downpay){
    const remaining = Math.max(0, cash - downpay);
    if(remaining === 0) return { remaining:0, sum:0 };
    const base = remaining / 0.70;
    const sum = roundRule(base);
    return { remaining, sum };
  }
  function monthly(sum, months){
    if(sum <= 0) return 0;
    return Math.ceil(sum / months);
  }

  function renderQuick(){
    const cash = parseMoneyInput(quickCash.value);
    const downpay = parseMoneyInput(quickDownpay.value);

    if(!cash){
      qRemaining.textContent = "‚Äî";
      qSum.textContent = "‚Äî";
      qMonthly.textContent = "‚Äî";
      qTotal.textContent = "‚Äî";
      pay6.textContent = "‚Äî";
      pay12.textContent = "‚Äî";
      pay24.textContent = "‚Äî";
      pay36.textContent = "‚Äî";
      qCopyBtn.disabled = true;
      qStatus.textContent = "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É";
      return;
    }

    const { remaining, sum } = installmentCalc(cash, downpay);

    qRemaining.textContent = formatRub(remaining) + "‚ÇΩ";
    qSum.textContent = formatRub(sum) + "‚ÇΩ";
    qMonthly.textContent = formatRub(monthly(sum, selectedMonths)) + "‚ÇΩ/–º–µ—Å";
    qTotal.textContent = formatRub(downpay + sum) + "‚ÇΩ";

    pay6.textContent = formatRub(monthly(sum, 6)) + "‚ÇΩ/–º–µ—Å";
    pay12.textContent = formatRub(monthly(sum, 12)) + "‚ÇΩ/–º–µ—Å";
    pay24.textContent = formatRub(monthly(sum, 24)) + "‚ÇΩ/–º–µ—Å";
    pay36.textContent = formatRub(monthly(sum, 36)) + "‚ÇΩ/–º–µ—Å";

    qCopyBtn.disabled = false;
    qStatus.textContent = "–ì–æ—Ç–æ–≤–æ";
  }
  const renderQuickDebounced = debounce(renderQuick, 120);

  function setActiveMonths(btn){
    monthsBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedMonths = parseInt(btn.dataset.months, 10);
    monthsPill2.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + selectedMonths + " –º–µ—Å";
    monthsPill.textContent = "–°—Ä–æ–∫: " + selectedMonths + " –º–µ—Å";
    renderQuick();
    if((instInputArea.value || "").trim() && (instOutputArea.value || "").trim()) doInstallment();
  }
  monthsBtns.forEach(btn => btn.addEventListener("click", () => setActiveMonths(btn)));

  [quickCash, quickDownpay, downpayInput].forEach(inp => {
    inp.addEventListener("blur", () => { inp.value = prettyInput(inp.value); });
  });
  quickCash.addEventListener("input", renderQuickDebounced);
  quickDownpay.addEventListener("input", renderQuickDebounced);

  qCopyBtn.addEventListener("click", async () => {
    const cash = parseMoneyInput(quickCash.value);
    const downpay = parseMoneyInput(quickDownpay.value);
    if(!cash) return;
    const { remaining, sum } = installmentCalc(cash, downpay);
    const text =
`–¶–µ–Ω–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ: ${formatRub(cash)}‚ÇΩ
–í–∑–Ω–æ—Å: ${formatRub(downpay)}‚ÇΩ
–û—Å—Ç–∞—Ç–æ–∫: ${formatRub(remaining)}‚ÇΩ
–°—É–º–º–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∏: ${formatRub(sum)}‚ÇΩ
–ü–ª–∞—Ç—ë–∂ ${selectedMonths} –º–µ—Å: ${formatRub(monthly(sum, selectedMonths))}‚ÇΩ/–º–µ—Å`;
    try{
      await navigator.clipboard.writeText(text);
      qStatus.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
      setTimeout(() => qStatus.textContent = "–ì–æ—Ç–æ–≤–æ", 700);
    }catch(e){
      qStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
      setTimeout(() => qStatus.textContent = "–ì–æ—Ç–æ–≤–æ", 900);
    }
  });

  function convertLineInstallment(line, downpay, months){
    const token = findLastNumberToken(line);
    if(!token) return { line, ok:false };
    const cash = parsePriceFromToken(token.text);
    if(cash == null) return { line, ok:false };

    const { remaining, sum } = installmentCalc(cash, downpay);
    const mp = monthly(sum, months);

    const sumFmt = formatRub(sum) + "‚ÇΩ";
    const mpFmt = formatRub(mp) + "‚ÇΩ/–º–µ—Å";

    let newLine = replaceToken(line, token, sumFmt);
    if(downpay > 0){
      const total = downpay + sum;
      newLine += `  |  ${months}–º: ${mpFmt}  |  –≤–∑–Ω–æ—Å: ${formatRub(downpay)}‚ÇΩ  |  –æ—Å—Ç–∞—Ç–æ–∫: ${formatRub(remaining)}‚ÇΩ  |  –∏—Ç–æ–≥–æ: ${formatRub(total)}‚ÇΩ`;
    } else {
      newLine += `  |  ${months}–º: ${mpFmt}`;
    }
    return { line: newLine, ok:true };
  }

  function doInstallment(){
    const downpay = parseMoneyInput(downpayInput.value);
    const lines = (instInputArea.value ?? "").split(/\r?\n/);

    let found = 0;
    const out = lines.map(l => {
      if(l.trim() === "") return "";
      const res = convertLineInstallment(l, downpay, selectedMonths);
      if(res.ok) found++;
      return res.line;
    }).join("\n");

    instOutputArea.value = out;

    if(found > 0){
      setPill(instStatusPill, true, "–ì–æ—Ç–æ–≤–æ");
      instCopyBtn.disabled = false;
    } else {
      setPill(instStatusPill, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω");
      instCopyBtn.disabled = true;
    }
  }
  const doInstallmentDebounced = debounce(doInstallment, 140);

  instCalcBtn.addEventListener("click", doInstallment);
  instInputArea.addEventListener("keydown", hotkey(doInstallment));
  instInputArea.addEventListener("input", () => {
    if((instInputArea.value || "").trim().length < 2000) doInstallmentDebounced();
  });
  downpayInput.addEventListener("input", () => {
    if((instInputArea.value || "").trim()) doInstallmentDebounced();
    renderQuickDebounced();
  });

  instClearBtn.addEventListener("click", () => {
    downpayInput.value = "";
    instInputArea.value = "";
    instOutputArea.value = "";
    instCopyBtn.disabled = true;
    setPill(instStatusPill, false, "–û–∂–∏–¥–∞—é –≤–≤–æ–¥");
  });

  instExampleBtn.addEventListener("click", () => {
    downpayInput.value = "50 000";
    instInputArea.value =
`iPhone 15 Pro Max 100000
MacBook Air 13 84990
AirPods 4 19990`;
    doInstallment();
  });

  instCopyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(instOutputArea.value);
      setPill(instStatusPill, true, "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
      setTimeout(() => setPill(instStatusPill, true, "–ì–æ—Ç–æ–≤–æ"), 700);
    }catch(e){
      setPill(instStatusPill, false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  });

  renderQuick();
})();
</script>
</body>
</html>
