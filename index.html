<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü—Ä–∞–π—Å / –ë–µ–∑–Ω–∞–ª / Excel</title>

  <!-- SheetJS (XLSX) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel –≤ –±—Ä–∞—É–∑–µ—Ä–µ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel-2:#0f1117;
      --text:#f5f7ff;
      --muted:#b5bbd6;
      --accent:#7c9bff;
      --danger:#ff6b6b;
      --ok:#7dff9b;
      --border:rgba(255,255,255,0.08);
      --shadow: 0 8px 30px rgba(0,0,0,0.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124,155,255,0.18), transparent 60%),
        radial-gradient(1200px 600px at 90% 10%, rgba(102,255,209,0.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      padding: 28px 20px 10px;
      max-width: 1150px;
      margin: 0 auto;
    }
    h1{
      font-size: clamp(22px, 3vw, 34px);
      margin: 0 0 8px;
    }
    header p{
      margin:0 0 10px;
      color:var(--muted);
      line-height:1.5;
      max-width: 980px;
      font-size: 13px;
    }

    .tabbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .tab-btn{
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 750;
      cursor:pointer
    }
    .tab-btn.active{
      background: rgba(124,155,255,0.18);
      border-color: rgba(124,155,255,0.45);
    }

    main{
      max-width:1150px;
      margin: 0 auto;
      padding: 10px 20px 50px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 980px){
      main{ grid-template-columns: 1fr 1fr; align-items:start; }
    }
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 30%), var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
    }
    .card h2{font-size: 18px; margin: 0 0 10px;}
    .muted{color:var(--muted)}
    .small{font-size: 12.5px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{height:10px}

    textarea{
      width:100%;
      min-height: 360px;
      resize: vertical;
      padding: 12px 12px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.6px;
    }
    input[type="text"], input[type="number"]{
      padding: 10px 12px;
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
    }
    input.compact{width: 120px}
    input.mid{width: 220px}

    button{
      appearance:none;
      border:1px solid transparent;
      background: linear-gradient(90deg, var(--accent), #9b7cff);
      color:white;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 750;
      cursor:pointer;
      transition: transform .05s ease, filter .2s ease, opacity .2s ease;
    }
    button:hover{filter: brightness(1.05)}
    button:active{transform: translateY(1px)}
    button.secondary{background: transparent; border-color: var(--border); color: var(--text);}
    button.ghost{background: transparent; border-color: transparent; color: var(--muted);}
    button:disabled{ opacity: .55; cursor:not-allowed; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11.5px;
      background: rgba(255,255,255,0.06);
      border:1px solid var(--border);
      color: var(--muted);
      white-space: nowrap;
    }
    .pill.ok{color: #d9ffe5; background: rgba(125,255,155,0.08); border-color: rgba(125,255,155,0.25)}
    .pill.bad{color: #ffe1e1; background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.25)}

    .hint{
      padding: 10px 12px;
      background: rgba(124,155,255,0.08);
      border:1px solid rgba(124,155,255,0.28);
      border-radius: 12px;
      color: #e8ecff;
    }

    .markup-bar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .markup-btn{
      background: transparent;
      border:1px solid var(--border);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      line-height: 1;
      cursor:pointer;
    }
    .markup-btn.active{
      background: rgba(124,155,255,0.18);
      border-color: rgba(124,155,255,0.45);
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .stat{
      background: var(--panel-2);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }
    .stat .label{font-size: 11.5px; color: var(--muted)}
    .stat .value{font-size: 18px; font-weight: 850; margin-top: 2px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
  <header>
    <h1>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø—Ä–∞–π—Å–∞</h1>
    <p>
      <b>–ü—Ä–∞–π—Å</b> ‚Äî —Å—á–∏—Ç–∞–µ—Ç —Ü–µ–Ω—É –ø–æ –Ω–∞—Ü–µ–Ω–∫–µ (/–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç) –∏ –æ–∫—Ä—É–≥–ª—è–µ—Ç; –¥–ª—è –∑–∞–∫—É–ø–∞ &lt; 40 000 –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ç—É–ø–µ–Ω–∏ –¥–æ–±–∞–≤–æ–∫ –∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ.<br>
      <b>–ë–µ–∑–Ω–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞</b> ‚Äî –Ω–∞ –≤—Ö–æ–¥ —Ü–µ–Ω–∞ –∑–∞ –Ω–∞–ª, —Å—á–∏—Ç–∞–µ–º (—Ü–µ–Ω–∞ ‚àí –≤–∑–Ω–æ—Å) + –ø—Ä–æ—Ü–µ–Ω—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 25%) –∏ –æ–∫—Ä—É–≥–ª—è–µ–º. –°—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.<br>
      <b>Excel –ø—Ä–∞–π—Å—ã</b> ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Ü–µ–Ω—ã ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç–µ —à–∞–±–ª–æ–Ω ‚Üí —Å–∫–∞—á–∏–≤–∞–µ—Ç–µ Excel, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–µ–ª–∏ = ‚Äú–ü–æ –∑–∞–ø—Ä–æ—Å—É‚Äù. –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∞ ‚Äú–í—Å–µ –ø—Ä–∞–π—Å—ã‚Äù.
    </p>

    <div class="tabbar" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
      <button class="tab-btn active" id="tabPriceBtn" type="button">–ü—Ä–∞–π—Å</button>
      <button class="tab-btn" id="tabCashlessBtn" type="button">–ë–µ–∑–Ω–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞</button>
      <button class="tab-btn" id="tabExcelBtn" type="button">Excel –ø—Ä–∞–π—Å—ã</button>
    </div>
  </header>

  <!-- ===== TAB 1: PRICE ===== -->
  <div id="priceTab" class="tab-panel active">
    <main>
      <section class="card">
        <h2>–ü—Ä–∞–π—Å ‚Äî –≤—Ö–æ–¥</h2>
        <p class="muted small">
          –í –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –∏—â–µ–º <b>–ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</b> ‚Äî —Å—á–∏—Ç–∞–µ–º –µ–≥–æ —Ü–µ–Ω–æ–π.
        </p>

        <div class="hint small">
          –ù–∞—Ü–µ–Ω–∫–∞ (–¥–ª—è –∑–∞–∫—É–ø–∞ <b>‚â• 40 000</b>):
          <div class="markup-bar" role="group" aria-label="–í—ã–±–æ—Ä –Ω–∞—Ü–µ–Ω–∫–∏">
            <button class="markup-btn" data-factor="0.94" type="button">+6%</button>
            <button class="markup-btn" data-factor="0.93" type="button">+7%</button>
            <button class="markup-btn" data-factor="0.92" type="button">+8%</button>
            <button class="markup-btn" data-factor="0.90" type="button">+10%</button>
            <button class="markup-btn active" data-factor="0.88" type="button">+12%</button>
            <button class="markup-btn" data-factor="0.85" type="button">+15%</button>
            <button class="markup-btn" data-factor="0.80" type="button">+20%</button>
            <button class="markup-btn" data-factor="0.70" type="button">+30%</button>
            <span class="pill ok" id="markupPill">–í—ã–±—Ä–∞–Ω–æ: +12% (/0.88)</span>
          </div>
        </div>

        <div class="spacer"></div>
        <textarea id="inputArea" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫..."></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="convertBtn" type="button">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
          <button id="clearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="exampleBtn" class="ghost" type="button">–ü—Ä–∏–º–µ—Ä</button>
          <span class="pill" title="Ctrl/‚åò + Enter">Ctrl/‚åò+Enter</span>
        </div>

        <div class="stats">
          <div class="stat"><div class="label">–°—Ç—Ä–æ–∫ –≤—Å–µ–≥–æ</div><div id="statLines" class="value">0</div></div>
          <div class="stat"><div class="label">–¶–µ–Ω –Ω–∞–π–¥–µ–Ω–æ</div><div id="statFound" class="value">0</div></div>
          <div class="stat"><div class="label">–ë–µ–∑ —Ü–µ–Ω—ã</div><div id="statNoPrice" class="value">0</div></div>
        </div>

        <div class="spacer"></div>
        <div class="hint small">
          –î–ª—è –∑–∞–∫—É–ø–∞ <b>&lt; 40 000</b> –ø—Ä–∏–±–∞–≤–ª—è–µ–º –∏ –∑–∞—Ç–µ–º –æ–∫—Ä—É–≥–ª—è–µ–º:
          &lt;4 000 ‚Üí +1 500; &lt;10 000 ‚Üí +2 000; &lt;15 000 ‚Üí +2 500; &lt;20 000 ‚Üí +3 000; &lt;40 000 ‚Üí +4 000.<br>
          –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –ø–æ –æ—Å—Ç–∞—Ç–∫—É –≤–Ω—É—Ç—Ä–∏ —Ç—ã—Å—è—á–∏:
          ‚â§250 ‚Üí 990 –ø—Ä–µ–¥—ã–¥—É—â–µ–π; &gt;250 –∏ &lt;750 ‚Üí 490 —Ç–µ–∫—É—â–µ–π; ‚â•750 ‚Üí 990 —Ç–µ–∫—É—â–µ–π.
        </div>
      </section>

      <section class="card">
        <h2>–ü—Ä–∞–π—Å ‚Äî –≤—ã—Ö–æ–¥</h2>
        <p class="muted small">–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Ç—ã—Å—è—á —Ç–æ—á–∫–æ–π + —Å–∏–º–≤–æ–ª ‚ÇΩ. –û—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
        <textarea id="outputArea" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç..." readonly></textarea>
        <div class="spacer"></div>
        <div class="row">
          <button id="copyBtn" class="secondary" type="button" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <span id="statusPill" class="pill bad">–û–∂–∏–¥–∞—é –≤–≤–æ–¥</span>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== TAB 2: CASHLESS ===== -->
  <div id="cashlessTab" class="tab-panel">
    <main>
      <section class="card">
        <h2>–ë–µ–∑–Ω–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Äî –≤—Ö–æ–¥</h2>
        <p class="muted small">
          –ù–∞ –≤—Ö–æ–¥–µ ‚Äî <b>—Ü–µ–Ω–∞ –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ</b>. –ë–µ–∑–Ω–∞–ª = round((—Ü–µ–Ω–∞ ‚àí –≤–∑–Ω–æ—Å) √ó (1 + %/100)).
          <b>–°—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</b>: –µ—Å–ª–∏ —Å—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞—Ç—å, –≤ –≤—ã–≤–æ–¥–µ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —Å—É–º–º–∞ –±–µ–∑–Ω–∞–ª–∞.
        </p>

        <div class="hint small">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="muted small">–í–∑–Ω–æ—Å, ‚ÇΩ:</span>
              <input id="downpayInput" class="mid" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 50 000" inputmode="numeric" />
            </div>
            <div class="row">
              <span class="muted small">–ù–∞—Ü–µ–Ω–∫–∞ –±–µ–∑–Ω–∞–ª, %:</span>
              <input id="cashlessPercent" class="compact" type="number" min="0" step="1" value="25" />
            </div>
            <span class="pill" id="cashlessRulePill">+25%</span>
          </div>

          <div class="spacer"></div>

          –°—Ä–æ–∫:
          <div class="markup-bar" role="group" aria-label="–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã">
            <button class="markup-btn" data-months="6" type="button">6 –º–µ—Å</button>
            <button class="markup-btn" data-months="12" type="button">12 –º–µ—Å</button>
            <button class="markup-btn" data-months="24" type="button">24 –º–µ—Å</button>
            <button class="markup-btn" data-months="36" type="button">36 –º–µ—Å</button>
            <span class="pill" id="monthsPill">–°—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
          </div>
        </div>

        <div class="spacer"></div>
        <textarea id="cashlessInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω –∑–∞ –Ω–∞–ª–∏—á–Ω—ã–µ..."></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="cashlessCalcBtn" type="button">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
          <button id="cashlessClearBtn" class="secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
          <button id="cashlessExampleBtn" class="ghost" type="button">–ü—Ä–∏–º–µ—Ä</button>
          <span class="pill" title="Ctrl/‚åò + Enter">Ctrl/‚åò+Enter</span>
        </div>

        <div class="spacer"></div>
        <div class="hint small">
          –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—Ä–æ–∫: ‚åà—Å—É–º–º–∞/–º–µ—Å—è—Ü–µ–≤‚åâ.
        </div>
      </section>

      <section class="card">
        <h2>–ë–µ–∑–Ω–∞–ª–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Äî –≤—ã—Ö–æ–¥</h2>
        <p class="muted small">
          –í —Å—Ç—Ä–æ–∫–µ —Ü–µ–Ω–∞ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ <b>—Å—É–º–º—É –±–µ–∑–Ω–∞–ª–∞</b>. –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—Ä–æ–∫ ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è ‚Äú| 12–º: 9.999‚ÇΩ/–º–µ—Å‚Äù.
        </p>
        <textarea id="cashlessOutput" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç..." readonly></textarea>
        <div class="spacer"></div>
        <div class="row">
          <button id="cashlessCopyBtn" class="secondary" type="button" disabled>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          <span id="cashlessStatusPill" class="pill bad">–û–∂–∏–¥–∞—é –≤–≤–æ–¥</span>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== TAB 3: EXCEL ===== -->
  <div id="excelTab" class="tab-panel">
    <main>
      <section class="card">
        <h2>Excel –ø—Ä–∞–π—Å—ã ‚Äî –≤—Ö–æ–¥</h2>
        <p class="muted small">
          –í—Å—Ç–∞–≤—å—Ç–µ —Ü–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞ ‚Äú–º–æ–¥–µ–ª—å ‚Ä¶ —Ü–µ–Ω–∞‚ÇΩ‚Äù. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω—É–∂–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞ ‚Äî Excel —Å–∫–∞—á–∞–µ—Ç—Å—è.
          –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –∏–∑ —à–∞–±–ª–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤–æ –≤—Ö–æ–¥–µ ‚Äî –≤ —Ü–µ–Ω–µ –±—É–¥–µ—Ç <b>‚Äú–ü–æ –∑–∞–ø—Ä–æ—Å—É‚Äù</b>.
        </p>

        <div class="hint small">
          –®–∞–±–ª–æ–Ω—ã –¥–æ–ª–∂–Ω—ã –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å <span class="mono">index.html</span>:
          <span class="mono">13 –∞–π—Ñ–æ–Ω—ã.xlsx</span>, <span class="mono">14 –∞–π—Ñ–æ–Ω—ã.xlsx</span>, <span class="mono">15 –∞–π—Ñ–æ–Ω—ã.xlsx</span>,
          <span class="mono">16 –∞–π—Ñ–æ–Ω—ã.xlsx</span>, <span class="mono">17 –∞–π—Ñ–æ–Ω—ã —Å–∏–º.xlsx</span>, <span class="mono">17 –∞–π—Ñ–æ–Ω—ã –µ—Å–∏–º.xlsx</span>.
        </div>

        <div class="spacer"></div>
        <textarea id="excelInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ —Ü–µ–Ω (13/14/15/16/17)..."></textarea>

        <div class="spacer"></div>
        <div class="row">
          <button id="btnAll" type="button">–í—Å–µ –ø—Ä–∞–π—Å—ã</button>
          <button id="btn13" type="button">13 –∞–π—Ñ–æ–Ω—ã</button>
          <button id="btn14" type="button">14 –∞–π—Ñ–æ–Ω—ã</button>
          <button id="btn15" type="button">15 –∞–π—Ñ–æ–Ω—ã</button>
          <button id="btn16" type="button">16 –∞–π—Ñ–æ–Ω—ã</button>
          <button id="btn17sim" type="button">17 –∞–π—Ñ–æ–Ω—ã SIM</button>
          <button id="btn17esim" type="button">17 –∞–π—Ñ–æ–Ω—ã eSIM</button>
          <button id="excelExampleBtn" class="ghost" type="button">–ü—Ä–∏–º–µ—Ä</button>
        </div>

        <div class="spacer"></div>
        <div class="row">
          <span id="excelStatus" class="pill bad">–û–∂–∏–¥–∞—é –≤–≤–æ–¥</span>
          <span id="excelStats" class="pill">‚Äî</span>
        </div>

        <div class="spacer"></div>
        <div class="hint small">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ 17-—ã–º: –¥–ª—è ‚Äú17 SIM‚Äù –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –±–µ—Ä—ë—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ eSIM, –¥–ª—è ‚Äú17 eSIM‚Äù ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å eSIM/üáØüáµ/üá∫üá∏.
          –ï—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–µ—Ç ‚Äî –±–µ—Ä—ë—Ç—Å—è –ª—é–±–æ–π —Å–æ–≤–ø–∞–¥–∞—é—â–∏–π.
        </div>

        <div class="spacer"></div>
        <div class="hint small">
          –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä —Å–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç–µ, —á—Ç–æ–±—ã ‚Äú–í—Å–µ –ø—Ä–∞–π—Å—ã‚Äù —Å–∫–∞—á–∞–ª 6 —Ñ–∞–π–ª–æ–≤ –ø–æ–¥—Ä—è–¥.
        </div>
      </section>

      <section class="card">
        <h2>Excel –ø—Ä–∞–π—Å—ã ‚Äî –∑–∞–º–µ—Ç–∫–∏</h2>
        <p class="muted small">
          –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ ‚Äú–Ω–µ –Ω–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω‚Äù ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª—ã —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Ä—è–¥–æ–º —Å HTML –∏ –∏–º–µ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—é—Ç.
        </p>
        <div class="hint small">
          –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω—ã –≤ –ø–æ–¥–ø–∞–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä <span class="mono">/templates</span>), –ø–æ–º–µ–Ω—è–π—Ç–µ –≤ –∫–æ–¥–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
          <span class="mono">TEMPLATE_BASE</span>.
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  /* ===== helpers ===== */
  function formatRub(n){
    const s = String(Math.trunc(n));
    return s.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }
  function parseMoneyDigits(s){
    const digits = String(s || "").replace(/\D/g, "");
    return digits ? parseInt(digits, 10) : 0;
  }
  function roundRule(value){
    if(!isFinite(value) || value <= 0) return 0;
    const baseTh = Math.floor(value / 1000) * 1000;
    const rem = value - baseTh;
    if(rem <= 250){
      if(baseTh === 0) return 990;
      return (baseTh - 1000) + 990;
    }
    if(rem < 750) return baseTh + 490;
    return baseTh + 990;
  }
  function findLastNumberToken(line){
    const re = /\d[\d\s.,]*\d|\d/g;
    let m, last = null;
    while((m = re.exec(line)) !== null){
      last = { text: m[0], index: m.index };
    }
    return last;
  }
  function parsePriceFromToken(tokenText){
    const digits = String(tokenText || "").replace(/\D/g, "");
    if(!digits) return null;
    return parseInt(digits, 10);
  }
  function replaceToken(line, token, replacement){
    const before = line.slice(0, token.index);
    const after = line.slice(token.index + token.text.length);
    return before + replacement + after;
  }
  function setPill(el, ok, text){
    el.className = "pill " + (ok ? "ok" : "bad");
    el.textContent = text;
  }
  function debounce(fn, delay){
    let t = null;
    return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
  }
  function hotkey(handler){
    return (e) => {
      const isMac = (navigator.platform || "").toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if(mod && e.key === "Enter"){ e.preventDefault(); handler(); }
    };
  }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  /* ===== Tabs ===== */
  const tabPriceBtn = $("tabPriceBtn");
  const tabCashlessBtn = $("tabCashlessBtn");
  const tabExcelBtn = $("tabExcelBtn");
  const priceTab = $("priceTab");
  const cashlessTab = $("cashlessTab");
  const excelTab = $("excelTab");

  function setTab(which){
    const isPrice = which === "price";
    const isCashless = which === "cashless";
    const isExcel = which === "excel";

    tabPriceBtn.classList.toggle("active", isPrice);
    tabCashlessBtn.classList.toggle("active", isCashless);
    tabExcelBtn.classList.toggle("active", isExcel);

    priceTab.classList.toggle("active", isPrice);
    cashlessTab.classList.toggle("active", isCashless);
    excelTab.classList.toggle("active", isExcel);
  }
  tabPriceBtn.addEventListener("click", () => setTab("price"));
  tabCashlessBtn.addEventListener("click", () => setTab("cashless"));
  tabExcelBtn.addEventListener("click", () => setTab("excel"));

  /* =========================
     TAB 1: PRICE
  ========================== */
  const inputArea = $("inputArea");
  const outputArea = $("outputArea");
  const convertBtn = $("convertBtn");
  const clearBtn = $("clearBtn");
  const exampleBtn = $("exampleBtn");
  const copyBtn = $("copyBtn");
  const statusPill = $("statusPill");

  const statLines = $("statLines");
  const statFound = $("statFound");
  const statNoPrice = $("statNoPrice");

  const markupBtns = Array.from(document.querySelectorAll('#priceTab .markup-btn[data-factor]'));
  const markupPill = $("markupPill");

  let selectedFactor = 0.88;

  function cashAdd(p){
    if(p < 4000) return 1500;
    if(p < 10000) return 2000;
    if(p < 15000) return 2500;
    if(p < 20000) return 3000;
    if(p < 40000) return 4000;
    return 0;
  }

  function convertLinePrice(line){
    const token = findLastNumberToken(line);
    if(!token) return { line, ok:false };
    const price = parsePriceFromToken(token.text);
    if(price == null) return { line, ok:false };

    let baseValue;
    if(price < 40000) baseValue = price + cashAdd(price);
    else baseValue = price / selectedFactor;

    const rounded = roundRule(baseValue);
    const formatted = formatRub(rounded) + "‚ÇΩ";
    return { line: replaceToken(line, token, formatted), ok:true };
  }

  function updateStats(linesCount, foundCount){
    statLines.textContent = String(linesCount);
    statFound.textContent = String(foundCount);
    statNoPrice.textContent = String(Math.max(0, linesCount - foundCount));
  }

  function doConvertPrice(){
    const lines = (inputArea.value ?? "").split(/\r?\n/);
    let found = 0;
    const out = lines.map(l => {
      if(l.trim() === "") return "";
      const res = convertLinePrice(l);
      if(res.ok) found++;
      return res.line;
    }).join("\n");

    outputArea.value = out;

    const nonEmpty = lines.filter(l => l.trim() !== "").length;
    updateStats(nonEmpty, found);

    if(found > 0){
      setPill(statusPill, true, "–ì–æ—Ç–æ–≤–æ");
      copyBtn.disabled = false;
    } else {
      setPill(statusPill, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω");
      copyBtn.disabled = true;
    }
  }

  function setActiveMarkupButton(btn){
    markupBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedFactor = parseFloat(btn.dataset.factor);
    markupPill.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${btn.textContent.trim()} (/${selectedFactor.toFixed(2)})`;
    if((inputArea.value || "").trim() && (outputArea.value || "").trim()) doConvertPrice();
  }

  markupBtns.forEach(btn => btn.addEventListener("click", () => setActiveMarkupButton(btn)));
  convertBtn.addEventListener("click", doConvertPrice);
  inputArea.addEventListener("keydown", hotkey(doConvertPrice));

  clearBtn.addEventListener("click", () => {
    inputArea.value = "";
    outputArea.value = "";
    updateStats(0,0);
    copyBtn.disabled = true;
    setPill(statusPill, false, "–û–∂–∏–¥–∞—é –≤–≤–æ–¥");
  });

  exampleBtn.addEventListener("click", () => {
    inputArea.value =
`AirPods 4 ANC 34900üáØüáµ
Apple Watch SE 40 39.500üá¶üá™

16E 256 Black 54400üáÆüá≥
17 Air 256 Blue eSim 70800üá∫üá∏`;
  });

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(outputArea.value);
      setPill(statusPill, true, "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
      setTimeout(() => setPill(statusPill, true, "–ì–æ—Ç–æ–≤–æ"), 700);
    }catch(e){
      setPill(statusPill, false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  });

  /* =========================
     TAB 2: CASHLESS
  ========================== */
  const downpayInput = $("downpayInput");
  const cashlessPercent = $("cashlessPercent");
  const cashlessRulePill = $("cashlessRulePill");

  const cashlessInput = $("cashlessInput");
  const cashlessOutput = $("cashlessOutput");
  const cashlessCalcBtn = $("cashlessCalcBtn");
  const cashlessClearBtn = $("cashlessClearBtn");
  const cashlessExampleBtn = $("cashlessExampleBtn");
  const cashlessCopyBtn = $("cashlessCopyBtn");
  const cashlessStatusPill = $("cashlessStatusPill");
  const monthsPill = $("monthsPill");

  const monthsBtns = Array.from(document.querySelectorAll('#cashlessTab .markup-btn[data-months]'));
  let selectedMonths = null;

  function currentPercent(){
    const v = parseFloat(String(cashlessPercent.value || "0").replace(",", "."));
    return (isFinite(v) && v >= 0) ? Math.round(v) : 0;
  }
  function refreshCashlessPill(){
    cashlessRulePill.textContent = `+${currentPercent()}%`;
  }

  function cashlessCalc(cash, downpay, percent){
    const remaining = Math.max(0, cash - downpay);
    const base = remaining * (1 + (percent / 100));
    const sum = roundRule(base);
    return { sum };
  }
  function monthly(sum, months){
    if(!months || sum <= 0) return 0;
    return Math.ceil(sum / months);
  }

  function convertLineCashless(line, downpay, months, percent){
    const token = findLastNumberToken(line);
    if(!token) return { line, ok:false };
    const cash = parsePriceFromToken(token.text);
    if(cash == null) return { line, ok:false };

    const { sum } = cashlessCalc(cash, downpay, percent);
    const sumFmt = formatRub(sum) + "‚ÇΩ";
    let newLine = replaceToken(line, token, sumFmt);

    if(months){
      const mp = monthly(sum, months);
      const mpFmt = formatRub(mp) + "‚ÇΩ/–º–µ—Å";
      newLine += `  |  ${months}–º: ${mpFmt}`;
    }
    return { line: newLine, ok:true };
  }

  function doCashless(){
    const dp = parseMoneyDigits(downpayInput.value);
    const pct = currentPercent();

    cashlessPercent.value = String(pct);
    refreshCashlessPill();

    const lines = (cashlessInput.value ?? "").split(/\r?\n/);
    let found = 0;
    const out = lines.map(l => {
      if(l.trim() === "") return "";
      const res = convertLineCashless(l, dp, selectedMonths, pct);
      if(res.ok) found++;
      return res.line;
    }).join("\n");

    cashlessOutput.value = out;

    if(found > 0){
      setPill(cashlessStatusPill, true, "–ì–æ—Ç–æ–≤–æ");
      cashlessCopyBtn.disabled = false;
    } else {
      setPill(cashlessStatusPill, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω");
      cashlessCopyBtn.disabled = true;
    }
  }

  function setActiveMonths(btn){
    monthsBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedMonths = parseInt(btn.dataset.months, 10);
    monthsPill.textContent = "–í—ã–±—Ä–∞–Ω–æ: " + selectedMonths + " –º–µ—Å";
    if((cashlessInput.value || "").trim() && (cashlessOutput.value || "").trim()) doCashless();
  }
  monthsBtns.forEach(btn => btn.addEventListener("click", () => setActiveMonths(btn)));

  cashlessCalcBtn.addEventListener("click", doCashless);
  cashlessInput.addEventListener("keydown", hotkey(doCashless));

  cashlessClearBtn.addEventListener("click", () => {
    downpayInput.value = "";
    cashlessInput.value = "";
    cashlessOutput.value = "";
    cashlessCopyBtn.disabled = true;

    selectedMonths = null;
    monthsBtns.forEach(b => b.classList.remove("active"));
    monthsPill.textContent = "–°—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω";

    refreshCashlessPill();
    setPill(cashlessStatusPill, false, "–û–∂–∏–¥–∞—é –≤–≤–æ–¥");
  });

  cashlessExampleBtn.addEventListener("click", () => {
    downpayInput.value = "50 000";
    cashlessPercent.value = "25";
    refreshCashlessPill();

    selectedMonths = null;
    monthsBtns.forEach(b => b.classList.remove("active"));
    monthsPill.textContent = "–°—Ä–æ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω";

    cashlessInput.value =
`iPhone 15 Pro Max 100000
MacBook Air 13 84990
AirPods 4 19990`;
  });

  cashlessCopyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(cashlessOutput.value);
      setPill(cashlessStatusPill, true, "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
      setTimeout(() => setPill(cashlessStatusPill, true, "–ì–æ—Ç–æ–≤–æ"), 700);
    }catch(e){
      setPill(cashlessStatusPill, false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  });

  cashlessPercent.addEventListener("input", debounce(() => {
    cashlessPercent.value = String(currentPercent());
    refreshCashlessPill();
    if((cashlessInput.value || "").trim() && (cashlessOutput.value || "").trim()) doCashless();
  }, 80));

  downpayInput.addEventListener("blur", () => {
    const v = parseMoneyDigits(downpayInput.value);
    downpayInput.value = v ? String(v).replace(/\B(?=(\d{3})+(?!\d))/g, " ") : "";
  });

  refreshCashlessPill();

  /* =========================
     TAB 3: EXCEL generator
  ========================== */
  const TEMPLATE_BASE = "./"; // –µ—Å–ª–∏ —à–∞–±–ª–æ–Ω—ã –≤ –ø–∞–ø–∫–µ templates ‚Üí "./templates/"

  const excelInput = $("excelInput");
  const excelStatus = $("excelStatus");
  const excelStats = $("excelStats");
  const excelExampleBtn = $("excelExampleBtn");

  const btnAll = $("btnAll");
  const btn13 = $("btn13");
  const btn14 = $("btn14");
  const btn15 = $("btn15");
  const btn16 = $("btn16");
  const btn17sim = $("btn17sim");
  const btn17esim = $("btn17esim");

  const excelButtons = [btnAll, btn13, btn14, btn15, btn16, btn17sim, btn17esim, excelExampleBtn];

  const templates = {
    t13: { label:"13 –∞–π—Ñ–æ–Ω—ã", file:"13 –∞–π—Ñ–æ–Ω—ã.xlsx", wantEsim: null },
    t14: { label:"14 –∞–π—Ñ–æ–Ω—ã", file:"14 –∞–π—Ñ–æ–Ω—ã.xlsx", wantEsim: null },
    t15: { label:"15 –∞–π—Ñ–æ–Ω—ã", file:"15 –∞–π—Ñ–æ–Ω—ã.xlsx", wantEsim: null },
    t16: { label:"16 –∞–π—Ñ–æ–Ω—ã", file:"16 –∞–π—Ñ–æ–Ω—ã.xlsx", wantEsim: null },
    t17sim: { label:"17 –∞–π—Ñ–æ–Ω—ã SIM", file:"17 –∞–π—Ñ–æ–Ω—ã —Å–∏–º.xlsx", wantEsim: false },
    t17esim:{ label:"17 –∞–π—Ñ–æ–Ω—ã eSIM", file:"17 –∞–π—Ñ–æ–Ω—ã –µ—Å–∏–º.xlsx", wantEsim: true },
  };

  async function fetchTemplateArrayBuffer(filename){
    const url = TEMPLATE_BASE + encodeURIComponent(filename);
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω: ${filename} (HTTP ${res.status})`);
    return await res.arrayBuffer();
  }

  function downloadArrayBufferAsFile(ab, filename){
    const blob = new Blob([ab], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 1500);
  }

  function stripEmojiAndFlags(s){
    let t = String(s || "");
    t = t.replace(/[\u{1F1E6}-\u{1F1FF}]/gu, "");
    try { t = t.replace(/\p{Extended_Pictographic}/gu, ""); } catch(e) {}
    return t;
  }
  function normalizeSpaces(s){ return String(s || "").replace(/\s+/g, " ").trim(); }

  function canonKeyFromText(text){
    let raw = String(text || "");
    const rawLower = raw.toLowerCase();
    const esim = rawLower.includes("esim") || raw.includes("üáØüáµ") || raw.includes("üá∫üá∏");

    let t = rawLower;
    t = t.replace(/apple/g, " ");
    t = t.replace(/iphone/g, " ");
    t = stripEmojiAndFlags(t);
    t = t.replace(/[()\-‚Äì‚Äî,:;‚Ä¢‚ñ™Ô∏è]/g, " ");
    t = t.replace(/\+/g, " plus ");
    t = t.replace(/\bpro\s*max\b/g, " pro max ");
    t = t.replace(/\bpromax\b/g, " pro max ");
    t = t.replace(/\b1\s*tb\b/g, " 1tb ");
    t = t.replace(/\b(\d+)\s*gb\b/g, "$1gb");
    t = t.replace(/\b(\d+)\s*tb\b/g, "$1tb");
    t = normalizeSpaces(t);

    const tokens = t.split(" ").filter(Boolean);
    const seriesIdx = tokens.findIndex(x => /^(1[3-7])$/.test(x) || /^(1[3-7])[a-z]$/.test(x));
    if(seriesIdx === -1) return { key: t, esim };

    const series = tokens[seriesIdx].replace(/[^0-9]/g, "");
    let variant = "";
    const hasAir = tokens.includes("air");
    const hasPlus = tokens.includes("plus");
    const hasPro = tokens.includes("pro");
    const hasMax = tokens.includes("max");

    if(hasAir) variant = "air";
    else if(hasPro && hasMax) variant = "pro max";
    else if(hasPro) variant = "pro";
    else if(hasPlus) variant = "plus";

    let storage = "";
    for(const tk of tokens){
      if(/^(64|128|256|512)gb$/.test(tk)){ storage = tk; break; }
      if(/^1tb$/.test(tk) || /^2tb$/.test(tk)){ storage = tk; break; }
    }

    const drop = new Set(["apple","iphone","esim", series, "pro", "max", "plus", "air"]);
    let rest = tokens.filter(x => !drop.has(x));
    if(storage) rest = rest.filter(x => x !== storage);
    rest = rest.filter(x => x !== "gb" && x !== "tb");
    const color = rest.join(" ").trim();

    const key = normalizeSpaces([series, variant, storage, color].filter(Boolean).join(" "));
    return { key, esim };
  }

  function buildPriceMapFromInput(multiline){
    const map = new Map();
    const lines = String(multiline || "").split(/\r?\n/);
    let parsed = 0;

    for(const line of lines){
      if(!line.trim()) continue;
      const token = findLastNumberToken(line);
      if(!token) continue;
      const n = parsePriceFromToken(token.text);
      if(n == null) continue;

      const withoutPrice = replaceToken(line, token, " ");
      const { key, esim } = canonKeyFromText(withoutPrice);
      if(!key) continue;

      const priceStr = formatRub(n) + "‚ÇΩ";
      const entry = map.get(key) || {};
      if(esim) entry.esim = priceStr;
      else entry.sim = priceStr;
      entry.last = priceStr;
      map.set(key, entry);

      parsed++;
    }
    return { map, parsedLines: parsed };
  }

  function getPriceFromMap(map, key, wantEsim){
    const entry = map.get(key);
    if(!entry) return null;
    if(wantEsim === true) return entry.esim ?? entry.sim ?? entry.last ?? null;
    if(wantEsim === false) return entry.sim ?? entry.esim ?? entry.last ?? null;
    return entry.last ?? null;
  }

  function detectHeaderAndCols(ws){
    const ref = ws["!ref"];
    if(!ref) return null;
    const range = XLSX.utils.decode_range(ref);
    const maxScan = Math.min(range.e.r, range.s.r + 40);

    const headerKeywordsPrice = /(—Ü–µ–Ω–∞|price)/i;
    const headerKeywordsModel = /(–º–æ–¥–µ–ª—å|–Ω–∞–∏–º–µ–Ω|–Ω–∞–∑–≤–∞–Ω|—Ç–æ–≤–∞—Ä|model|item|product)/i;

    for(let r = range.s.r; r <= maxScan; r++){
      let rowVals = [];
      for(let c = range.s.c; c <= range.e.c; c++){
        const addr = XLSX.utils.encode_cell({r,c});
        const cell = ws[addr];
        rowVals.push(cell ? String(cell.v ?? "").trim() : "");
      }
      const joined = rowVals.join(" | ").toLowerCase();
      if(joined.includes("—Ü–µ–Ω–∞") || joined.includes("price")){
        let priceCol = null;
        let modelCol = null;
        for(let c = range.s.c; c <= range.e.c; c++){
          const h = rowVals[c - range.s.c].toLowerCase();
          if(priceCol === null && headerKeywordsPrice.test(h)) priceCol = c;
          if(modelCol === null && headerKeywordsModel.test(h)) modelCol = c;
        }
        if(priceCol === null) priceCol = range.e.c;
        if(modelCol === null) modelCol = range.s.c;
        return { range, headerRow: r, modelCol, priceCol };
      }
    }
    return { range, headerRow: range.s.r, modelCol: range.s.c, priceCol: range.e.c };
  }

  function getCell(ws, r, c){
    const addr = XLSX.utils.encode_cell({r,c});
    return ws[addr];
  }
  function getCellValue(ws, r, c){
    const cell = getCell(ws, r, c);
    return cell ? cell.v : "";
  }
  function setCellValue(ws, r, c, v){
    const addr = XLSX.utils.encode_cell({r,c});
    const cell = ws[addr] || (ws[addr] = { t:"s", v:"" });
    if(typeof v === "number"){ cell.t = "n"; cell.v = v; }
    else { cell.t = "s"; cell.v = String(v); }
  }

  async function buildAndFillWorkbook(template, priceMap){
    const buf = await fetchTemplateArrayBuffer(template.file);
    const wb = XLSX.read(buf, { type: "array", cellStyles: true });

    let changed = 0;
    let missing = 0;

    for(const sheetName of wb.SheetNames){
      const ws = wb.Sheets[sheetName];
      const meta = detectHeaderAndCols(ws);
      if(!meta) continue;

      const { range, headerRow, modelCol, priceCol } = meta;

      for(let r = headerRow + 1; r <= range.e.r; r++){
        const modelVal = getCellValue(ws, r, modelCol);
        const modelStr = normalizeSpaces(String(modelVal || ""));
        if(!modelStr) continue;
        if(/–∏—Ç–æ–≥–æ|total/i.test(modelStr)) continue;

        const { key } = canonKeyFromText(modelStr);
        if(!key) continue;

        const price = getPriceFromMap(priceMap, key, template.wantEsim);
        if(price){
          setCellValue(ws, r, priceCol, price);
          changed++;
        } else {
          setCellValue(ws, r, priceCol, "–ü–æ –∑–∞–ø—Ä–æ—Å—É");
          missing++;
        }
      }
    }

    return { wb, changed, missing };
  }

  function makeStamp(d){
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  }

  async function generateExcelSingle(template){
    if(!window.XLSX){
      setPill(excelStatus, false, "XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN).");
      return;
    }
    const inputText = String(excelInput.value || "").trim();
    if(!inputText){
      setPill(excelStatus, false, "–í—Å—Ç–∞–≤—å—Ç–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
      excelStats.textContent = "‚Äî";
      return;
    }

    setPill(excelStatus, true, "–°–æ–±–∏—Ä–∞—é —Ü–µ–Ω—ã‚Ä¶");
    excelStats.textContent = "‚Äî";

    const { map: priceMap, parsedLines } = buildPriceMapFromInput(inputText);
    if(parsedLines === 0){
      setPill(excelStatus, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω –≤–æ –≤—Ö–æ–¥–µ");
      return;
    }

    let filled;
    try{
      filled = await buildAndFillWorkbook(template, priceMap);
    }catch(err){
      setPill(excelStatus, false, String(err.message || err));
      return;
    }

    const now = new Date();
    const outName = `${template.label} (${makeStamp(now)}).xlsx`;

    try{
      const ab = XLSX.write(filled.wb, { bookType: "xlsx", type: "array" });
      downloadArrayBufferAsFile(ab, outName);
      setPill(excelStatus, true, "Excel —Å–∫–∞—á–∞–Ω");
      excelStats.textContent = `–í—Ö–æ–¥–Ω—ã—Ö —Ü–µ–Ω: ${parsedLines} ¬∑ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ${filled.changed} ¬∑ –ü–æ –∑–∞–ø—Ä–æ—Å—É: ${filled.missing}`;
    }catch(err){
      setPill(excelStatus, false, "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª");
    }
  }

  let allBusy = false;

  async function generateAllExcels(){
    if(allBusy) return;
    if(!window.XLSX){
      setPill(excelStatus, false, "XLSX –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (CDN).");
      return;
    }
    const inputText = String(excelInput.value || "").trim();
    if(!inputText){
      setPill(excelStatus, false, "–í—Å—Ç–∞–≤—å—Ç–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
      excelStats.textContent = "‚Äî";
      return;
    }

    const { map: priceMap, parsedLines } = buildPriceMapFromInput(inputText);
    if(parsedLines === 0){
      setPill(excelStatus, false, "–ù–µ –Ω–∞—à—ë–ª —Ü–µ–Ω –≤–æ –≤—Ö–æ–¥–µ");
      excelStats.textContent = "‚Äî";
      return;
    }

    allBusy = true;
    excelButtons.forEach(b => b && (b.disabled = true));
    setPill(excelStatus, true, "–ì–æ—Ç–æ–≤–ª—é 6 –ø—Ä–∞–π—Å–æ–≤‚Ä¶");
    excelStats.textContent = `–í—Ö–æ–¥–Ω—ã—Ö —Ü–µ–Ω: ${parsedLines}`;

    const now = new Date();
    const stamp = makeStamp(now);

    const list = [templates.t13, templates.t14, templates.t15, templates.t16, templates.t17sim, templates.t17esim];

    let totalChanged = 0;
    let totalMissing = 0;
    let okCount = 0;

    for(let i = 0; i < list.length; i++){
      const t = list[i];
      setPill(excelStatus, true, `${i+1}/6: ${t.label}‚Ä¶`);
      try{
        const filled = await buildAndFillWorkbook(t, priceMap);
        const outName = `${t.label} (${stamp}).xlsx`;
        const ab = XLSX.write(filled.wb, { bookType: "xlsx", type: "array" });
        downloadArrayBufferAsFile(ab, outName);

        okCount++;
        totalChanged += filled.changed;
        totalMissing += filled.missing;

        // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç –±—Ä–∞—É–∑–µ—Ä—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥–Ω—ã–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        await sleep(180);
      }catch(err){
        // –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –æ–¥–∏–Ω –∏–∑ —Ñ–∞–π–ª–æ–≤ —É–ø–∞–ª
        setPill(excelStatus, false, `–û—à–∏–±–∫–∞: ${t.label} ‚Äî ${String(err.message || err)}`);
        await sleep(450);
      }
    }

    if(okCount === 6){
      setPill(excelStatus, true, "–°–∫–∞—á–∞–Ω–æ: 6 —Ñ–∞–π–ª–æ–≤");
    } else {
      setPill(excelStatus, false, `–°–∫–∞—á–∞–Ω–æ: ${okCount}/6 (—á–∞—Å—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏)`);
    }
    excelStats.textContent = `–í—Ö–æ–¥–Ω—ã—Ö —Ü–µ–Ω: ${parsedLines} ¬∑ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ: ${totalChanged} ¬∑ –ü–æ –∑–∞–ø—Ä–æ—Å—É: ${totalMissing}`;

    excelButtons.forEach(b => b && (b.disabled = false));
    allBusy = false;
  }

  btnAll.addEventListener("click", generateAllExcels);
  btn13.addEventListener("click", () => generateExcelSingle(templates.t13));
  btn14.addEventListener("click", () => generateExcelSingle(templates.t14));
  btn15.addEventListener("click", () => generateExcelSingle(templates.t15));
  btn16.addEventListener("click", () => generateExcelSingle(templates.t16));
  btn17sim.addEventListener("click", () => generateExcelSingle(templates.t17sim));
  btn17esim.addEventListener("click", () => generateExcelSingle(templates.t17esim));

  excelExampleBtn.addEventListener("click", () => {
    excelInput.value =
`13 128GB Midnight üáÆüá≥ 40.490‚ÇΩ
14 128GB Midnight üáÆüá≥ 45.490‚ÇΩ
15 128GB Black üáÆüá≥ 48.990‚ÇΩ
16 128GB Black üáÆüá≥ 58.490‚ÇΩ
17 256GB Black üáØüáµ 71.490‚ÇΩ`;
    setPill(excelStatus, false, "–û–∂–∏–¥–∞—é –≤–≤–æ–¥");
    excelStats.textContent = "‚Äî";
  });

})();
</script>
</body>
</html>
